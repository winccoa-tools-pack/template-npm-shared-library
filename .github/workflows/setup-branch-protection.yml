name: Setup Git Flow Branch Protection

on:
    workflow_dispatch: # Allow manual trigger
    push:
        branches:
            - main
        paths:
            - ".github/workflows/setup-branch-protection.yml"

permissions:
    contents: read
    repository-projects: write
    issues: write
    pull-requests: write

jobs:
    setup-protection:
        runs-on: ubuntu-latest
        if: github.repository_owner == 'mPokornyETM'

        steps:
            - name: Setup Main Branch Protection
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;

                      try {
                        await github.rest.repos.updateBranchProtection({
                          owner,
                          repo,
                          branch: 'main',
                          required_status_checks: {
                            strict: true,
                            contexts: [
                              'test (18.x)',
                              'test (20.x)',
                              'package'
                            ]
                          },
                          enforce_admins: false,
                          required_pull_request_reviews: {
                            required_approving_review_count: 1,
                            dismiss_stale_reviews: true,
                            require_code_owner_reviews: false,
                            require_last_push_approval: true
                          },
                          restrictions: null,
                          allow_force_pushes: false,
                          allow_deletions: false,
                          block_creations: false,
                          required_conversation_resolution: true,
                          required_linear_history: true
                        });

                        // Disable squash merging to maintain Git Flow history
                        await github.rest.repos.update({
                          owner,
                          repo,
                          allow_squash_merge: false,
                          allow_merge_commit: true,
                          allow_rebase_merge: true
                        });

                        console.log('‚úÖ Main branch protection rules updated successfully');
                        console.log('üõ°Ô∏è Main branch rules: Strict protection for production');
                        console.log('üö´ Squash merging disabled to preserve Git Flow history');
                      } catch (error) {
                        console.error('‚ùå Failed to update main branch protection:', error);
                        // Don't fail the job if branch protection fails
                      }

            - name: Setup Develop Branch Protection
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;

                      try {
                        await github.rest.repos.updateBranchProtection({
                          owner,
                          repo,
                          branch: 'develop',
                          required_status_checks: {
                            strict: true,
                            contexts: [
                              'test (18.x)',
                              'test (20.x)',
                              'package'
                            ]
                          },
                          enforce_admins: false,
                          required_pull_request_reviews: {
                            required_approving_review_count: 1,
                            dismiss_stale_reviews: false,
                            require_code_owner_reviews: false,
                            require_last_push_approval: false,
                            bypass_pull_request_allowances: {
                              apps: ['github-actions'] // Allow GitHub Actions bot to bypass PR requirement
                            }
                          },
                          restrictions: null,
                          allow_force_pushes: true, // Allow for rebasing and cleanup
                          allow_deletions: false,
                          block_creations: false,
                          required_conversation_resolution: false,
                          required_linear_history: false
                        });

                        console.log('‚úÖ Develop branch protection rules updated successfully');
                        console.log('üîß Develop branch rules: Flexible for integration work');
                      } catch (error) {
                        console.error('‚ùå Failed to update develop branch protection:', error);
                        // Don't fail the job if branch protection fails
                      }

            - name: Display Git Flow Summary
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      console.log('üå≥ Git Flow Branch Protection Summary');
                      console.log('=====================================');
                      console.log('');
                      console.log('üìã Main Branch (Production):');
                      console.log('  ‚úÖ Required PR reviews (1+ reviewer)');
                      console.log('  ‚úÖ Required status checks (CI/CD)');
                      console.log('  ‚úÖ Dismiss stale reviews');
                      console.log('  ‚úÖ Require conversation resolution');
                      console.log('  ‚úÖ Require linear history');
                      console.log('  ‚úÖ Require fresh approvals after push');
                      console.log('  üö´ No force pushes');
                      console.log('  üö´ No deletions');
                      console.log('  üö´ No squash merging (preserves Git Flow history)');
                      console.log('  ‚úÖ Merge commits and rebase allowed');
                      console.log('');
                      console.log('üîß Develop Branch (Integration):');
                      console.log('  ‚úÖ Required PR reviews (1+ reviewer)');
                      console.log('  ‚úÖ Required status checks (CI/CD)');
                      console.log('  ‚úÖ Allow force pushes (for rebasing)');
                      console.log('  ‚úÖ More flexible review process');
                      console.log('  üö´ No deletions');
                      console.log('');
                      console.log('üìñ Git Flow Workflow:');
                      console.log('  ‚Ä¢ feature/* ‚Üí develop (via PR)');
                      console.log('  ‚Ä¢ release/* ‚Üí main + develop (via PR)');
                      console.log('  ‚Ä¢ hotfix/* ‚Üí main + develop (via PR)');
                      console.log('  ‚Ä¢ develop ‚Üí main (via release PR)');
                      console.log('');
                      console.log('üß™ Automated Releases:');
                      console.log('  ‚Ä¢ develop push ‚Üí pre-release (alpha/beta/rc)');
                      console.log('  ‚Ä¢ main push ‚Üí stable release');
                      console.log('');
                      console.log('üìö Documentation: docs/GITFLOW_WORKFLOW.md');
